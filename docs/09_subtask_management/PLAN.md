# Phase 9: Structured Subtask Management & Iterative Execution - Implementation Plan

## Status
**COMPLETE** - Implementation finished and tested.

## Context

Replace the current CHECKLIST.md markdown-based task tracking with a structured `subtasks.json` file that enables programmatic completion verification. Implement a "Ralph Wiggum style" iterative execution loop that continues running the agent until all subtasks are complete, ensuring tasks only transition to "review" when implementation is truly finished.

---

## Phase 1: TypeScript Types & Schema

- [x] 1.1 Add `Subtask` interface to `src/types/index.ts`
- [x] 1.2 Add `SubtasksFile` interface to `src/types/index.ts`
- [x] 1.3 Add `SubtaskStatus` type (`pending` | `in_progress` | `completed`)
- [x] 1.4 Export new types from types module

---

## Phase 2: Subtasks Service (`src/server/services/subtasks.ts`)

- [x] 2.1 Create `subtasks.ts` service file
- [x] 2.2 Implement `getSubtasksPath(docsPath: string)` - returns path to subtasks.json
- [x] 2.3 Implement `loadSubtasks(docsPath: string)` - parse and validate subtasks.json
- [x] 2.4 Implement `saveSubtasks(docsPath: string, subtasks: SubtasksFile)` - write subtasks.json
- [x] 2.5 Implement `updateSubtaskStatus(docsPath: string, subtaskId: string, status: SubtaskStatus)` - update single subtask
- [x] 2.6 Implement `getCompletionStats(subtasks: SubtasksFile)` - returns `{ total, completed, percentage }`
- [x] 2.7 Implement `isAllComplete(subtasks: SubtasksFile)` - returns boolean
- [x] 2.8 Implement `getIncompleteSubtasks(subtasks: SubtasksFile)` - returns array of incomplete subtasks

---

## Phase 3: Update Skill Reader (`src/server/services/skillReader.ts`)

- [x] 3.1 Add `$TASK_ID` to variable substitution in `loadSkillPrompt()`
- [x] 3.2 Update Task parameter type to include `id` field access
- [x] 3.3 Test variable substitution with new `$TASK_ID` variable

---

## Phase 4: Update Task Documentation (`src/server/services/taskDocs.ts`)

- [x] 4.1 Remove CHECKLIST.md generation from `createTaskDocsFolder()`
- [x] 4.2 Remove checklist template import
- [x] 4.3 Update `templates/index.ts` to remove checklist exports

---

## Phase 5: Iterative Execution Loop (`src/server/services/workflow.ts`)

- [x] 5.1 Import subtasks service functions
- [x] 5.2 Add `MAX_EXECUTE_ITERATIONS` constant (default: 5)
- [x] 5.3 Create `buildIterativeExecutePrompt(task, incompleteSubtasks, iteration)` function
- [x] 5.4 Modify `executeSingleStep('execute')` to check subtasks completion after run
- [x] 5.5 Implement iteration loop in execute step:
  - Run agent
  - Check subtasks.json for completion
  - If incomplete and iterations < max, re-run with feedback
  - If complete, transition to review
- [x] 5.6 Modify `executeFullWorkflow()` to use iterative execute step
- [x] 5.7 Add iteration count to workflow logs
- [x] 5.8 Broadcast iteration status via WebSocket

---

## Phase 6: API Endpoints (`src/server/routes/tasks.ts`)

- [x] 6.1 Add `GET /api/tasks/:id/subtasks` endpoint
- [x] 6.2 Add `PUT /api/tasks/:id/subtasks/:subtaskId` endpoint
- [x] 6.3 Add `GET /api/tasks/:id/subtasks/completion` endpoint
- [x] 6.4 Add request/response validation for subtask endpoints
- [x] 6.5 Handle errors (task not found, subtask not found, invalid status)

---

## Phase 7: Update /plan Skill

- [x] 7.1 Update `skills/plan/SKILL.md` to generate subtasks.json instead of CHECKLIST.md
- [x] 7.2 Document subtasks.json schema in skill file
- [x] 7.3 Add examples of good subtask definitions
- [x] 7.4 Update variable references to include `$TASK_ID`

---

## Phase 8: Testing & Verification

- [x] 8.1 Test subtasks.json generation via /plan skill
- [x] 8.2 Test iterative execution loop with incomplete subtasks
- [x] 8.3 Test completion verification before review transition
- [x] 8.4 Test API endpoints for subtask CRUD
- [x] 8.5 Test max iterations safety limit
- [x] 8.6 Verify WebSocket broadcasts iteration status
- [x] 8.7 Build passes without TypeScript errors

---

## Phase 9: Documentation Updates

- [x] 9.1 Update README.md with new workflow description
- [x] 9.2 Update SPEC.md with subtasks.json schema
- [x] 9.3 Update API documentation with new endpoints
- [x] 9.4 Create test report for Phase 9

---

## Success Criteria

- [x] CHECKLIST.md no longer generated for new tasks
- [x] subtasks.json generated by /plan skill with correct schema
- [x] Execute step loops until all subtasks complete
- [x] Tasks only move to "review" when 100% subtasks complete (or max iterations)
- [x] Max iterations prevents infinite loops
- [x] API endpoints functional for subtask management
- [x] Build passes with no TypeScript errors
